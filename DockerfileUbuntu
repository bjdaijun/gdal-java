# 构建参数
ARG build_java_version=17
ARG gdal_version=3.11.3        # 注意：3.11.3 可能未发布，请确认
ARG cuda_version=12.4.1          # 用于最终运行阶段

# ================= 阶段1：构建 GDAL（Ubuntu 22.04 + OpenJDK 17）=================
FROM ubuntu:22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# 设置 Ubuntu 22.04 官方源（可替换为阿里云/清华源加速）
RUN echo "deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse" >> /etc/apt/sources.list

# 安装 OpenJDK 17 和构建工具
RUN apt update && \
    apt install -y openjdk-17-jdk \
                   wget ca-certificates gnupg \
                   software-properties-common

# 添加 PostgreSQL APT 仓库（用于 libpq-dev 等）
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
RUN echo "deb http://apt.postgresql.org/pub/repos/apt/ jammy-pgdg main" > /etc/apt/sources.list.d/pgdg.list

RUN apt update

# 安装 GDAL 编译依赖
RUN apt install -y aria2 \
    build-essential cmake swig ant python3 python3-dev python3-setuptools python3-numpy \
    libproj-dev libarchive-dev libarmadillo-dev libblosc-dev \
    libcurl4-gnutls-dev libcrypto++-dev libdeflate-dev libexpat1-dev libfreexl-dev \
    libfyba-dev libgeotiff-dev libgeos-dev libgif-dev libheif-dev \
    libhdf4-alt-dev libhdf5-dev libjpeg-dev libtiff-dev libpng-dev libkml-dev libnetcdf-dev \
    libjson-c-dev libjxl-dev liblerc-dev libaec-dev \
    liblzma-dev libxml2-dev liblz4-dev libmuparser-dev \
    libmysql++-dev libmariadb-dev libpq-dev \
    libopenexr-dev libopenjp2-7-dev libssl-dev libpcre2-dev \
    libpoppler-dev libqhull-dev librasterlite2-dev libspatialite-dev \
    libsqlite3-dev libsfcgal-dev libwebp-dev libxerces-c-dev \
    zlib1g-dev libzstd-dev

# 验证 Java 安装
RUN java -version && javac -version

# 下载并解压 GDAL 源码
RUN aria2c -x 16 -s 16 -o /gdal.tar.gz "https://github.com/OSGeo/gdal/releases/download/v${gdal_version}/gdal-${gdal_version}.tar.gz"
RUN mkdir /gdal-src /gdal-install
RUN tar -xzf /gdal.tar.gz --strip-components=1 -C /gdal-src

# 构建 GDAL（启用 Java 绑定）
RUN cd /gdal-src \
    && mkdir build \
    && cd build \
    && cmake -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_INSTALL_PREFIX=/gdal-install \
             -DBUILD_JAVA_BINDINGS=ON \
             -DJAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 .. \
    && make -j$(nproc) \
    && make install

# ================= 阶段2：运行环境（基于 CUDA + Ubuntu 22.04）=================
FROM nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# 安装 OpenJDK 17（运行时只需 JRE，但为调试方便可装 JDK）
RUN apt update && \
    apt install -y openjdk-17-jre-headless wget tar

# 安装 Maven
ENV MAVEN_VERSION=3.9.6
ENV MAVEN_HOME=/opt/maven
RUN wget https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz -O /tmp/maven.tar.gz && \
    mkdir -p ${MAVEN_HOME} && \
    tar -xzf /tmp/maven.tar.gz -C ${MAVEN_HOME} --strip-components=1 && \
    rm /tmp/maven.tar.gz

# 配置软件源（含 PGDG）
RUN echo "deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse" >> /etc/apt/sources.list

RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
RUN echo "deb http://apt.postgresql.org/pub/repos/apt/ jammy-pgdg main" > /etc/apt/sources.list.d/pgdg.list

# 安装 GDAL 运行依赖
RUN apt update && \
    apt install -y tzdata \
    libproj22 libarchive13 libarmadillo11 \
    libblosc1 libcurl4 libcrypto++8 libdeflate0 libexpat1 \
    libfreexl1 libfyba0 libgeotiff5 libgeos3.11.1 libgeos-c1v5 \
    libgif7 libheif1 libhdf4-0-alt libhdf5-103-1 libjpeg62-turbo \
    libtiff5 libpng16-16 libnetcdf19 \
    libkmlbase1 libkmldom1 libkmlengine1 \
    libjson-c5 libjxl0.7 liblerc4 libaec0 \
    liblzma5 libxml2 liblz4-1 libmuparser2v5 \
    libmysql++3v5 libmariadb3 libpq5 \
    libopenexr-3-1-30 libopenjp2-7 libssl3 \
    libpcre2-8-0 libpcre2-16-0 libpcre2-32-0 libpcre2-posix3 \
    libpoppler126 libqhull8.0 libqhull-r8.0 libqhullcpp8.0 \
    librasterlite2-1 libspatialite7 libsqlite3-0 libsfcgal1 \
    libwebp7 libxerces-c3.2 zlib1g libzstd1 \
    && apt autopurge -y && apt clean && rm -rf /var/lib/apt/lists/*

# 拷贝构建产物
COPY --from=builder /gdal-install/. /usr/local/

# 设置环境变量
ENV LD_LIBRARY_PATH=/usr/local/lib:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu
ENV GDAL_DATA=/usr/local/share/gdal
ENV JAVA_TOOL_OPTIONS="-Djava.library.path=/usr/local/lib:/usr/local/lib/jni:/usr/java/packages/lib:/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu"
ENV PATH=${MAVEN_HOME}/bin:${PATH}
ENV TZ="Asia/Shanghai"
ENV LANG=C.UTF-8

# 启用 NVIDIA GPU 支持
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

CMD ["bash"]
